var SVG_ColumnarMap=function(svg_Initialize){this.addCMConfig=function(options){options=options||{};var config=$.extend(true,{},colMap_dfConfig,options);config.isColMap=true;return config};this.setCMConfig=function(opts,layerId){opts=opts||{};layerId=parseInt(layerId);if(isNaN(layerId)){return}var layerdata=SVG_INIT._getLayerData(layerId);if(!layerdata.isColMap){return}_setConfig(layerdata,opts);_Collects.handleColConfig(layerdata)};this.setCMData=function(series,layerId,config){series=series||[];layerId=parseInt(layerId);if(series.length===0||isNaN(layerId)){return}var layerdata=SVG_INIT._getLayerData(layerId);if(!layerdata.isColMap){return}if(config){_setConfig(layerdata,config);_Collects.handleColConfig(layerdata)}_creatColMap(series,layerdata,config)};this.disposeRender=function(){_Shaders=null;_Materials=null;_Geometries=null;_Collects=null;SVG_INIT=null;colMap=null;df_pGeo=null;df_pMat=null;df_ItdMesh=df_SltMesh=null;df_mouseDownFunction=null;df_mouseHoverFunction=null};this.setMouseDownFunction=function(func){df_mouseDownFunction=toFunction(func)};this.setMouseHoverFunction=function(func){df_mouseHoverFunction=toFunction(func)};this._mouseMoveIn=function(obj,event){if(!obj._isColumnar){return}df_ItdMesh=_heightHightObject(obj,1);df_mouseHoverFunction(_getColumnarInfor(obj,event))};this._mouseMoveOut=function(obj){if(obj._isColumnar){_setSelectInfor(obj,0)}if(df_ItdMesh){df_mouseHoverFunction(_getColumnarInfor(df_ItdMesh));df_ItdMesh=_heightHightObject(df_ItdMesh,0)}if(df_SltMesh){_setSelectInfor(df_SltMesh,1)}};this._mouseDown=function(obj,event){if(obj){df_SltMesh&&(df_SltMesh=_heightHightObject(df_SltMesh,0));if(!obj._isColumnar){return}df_SltMesh=_heightHightObject(obj,1);df_mouseDownFunction(_getColumnarInfor(obj,event))}else{df_SltMesh&&df_mouseDownFunction(_getColumnarInfor(df_SltMesh));df_SltMesh&&(df_SltMesh=_heightHightObject(df_SltMesh,0))}};function _heightHightObject(obj,value){_setSelectInfor(obj,value);return value===0?null:obj}this._setToRise=function(isRise,name){SVG_INIT.SVGMapLayers&&SVG_INIT.SVGMapLayers.children.forEach(function(layer){if(layer._isColMap){var child=layer.children[0],series=child._ser,_offset=0,isUpdate=false;
var translates=child.geometry.attributes["translate"];for(var i=0,len=series.length;i<len;i++){if((series[i].data||[]).length<=0||((series[i].position||[]).length<=0&&(series[i].vecs||[]).length<=0)){continue}var si=series[i],offset=_offset,_value=isRise?SVG_INIT._df_Tdata.py:0,l=si.data.length*si.vecs.length;if(_Collects.checkStr(name,si.name,true)){isUpdate=true;for(var k=0;k<l;k++){translates.setY(offset++,_value)}}_offset+=l}isUpdate&&(translates.needsUpdate=true)}})};var colMap=this,_startTime=0,_tR=0.5,df_pGeo=undefined,df_pMat=undefined,df_ItdMesh=null,df_SltMesh=null,SVG_INIT=svg_Initialize,df_mouseDownFunction=toFunction(),df_mouseHoverFunction=toFunction();var colMap_dfConfig={visible:true,isColMap:true,layerid:0,name:"柱状图层",series:[],txuepath:"",dynamic:{type:1,duration:0.5},lightDynamic:{offsetX:0,offsetY:0.5},offset:new THREE.Vector2(0,0.5),sColors:["#44b2ff"],eColors:["#59ff99"],tSColors:["#ffffff"],tEColors:["#ffffff"],type:1,showPosType:1,space:3,width:20,maxHeight:100,highlightColor:["#FF0000","#0000FF"],xyRatio:[1,1],xyOffset:[0,0],tags:{color:"#ffffff",size:30,top:0},_seg:4,_perimeter:1};var _Shaders={CylidVShader:["attribute vec4 translate;","attribute vec2 size;","attribute vec4 sColor;","attribute vec4 eColor;","uniform float maxHeight;","uniform float width;","uniform float perimeter;","uniform float ratioHeight;","uniform float opacity;","uniform vec4 sHColor;","uniform vec4 eHColor;","#ifdef USE_TXUE","uniform float u_time;","uniform vec2 offset;","varying vec2 vUv;","#endif","varying vec3 tPos;","varying vec4 vSColor;","varying vec4 vEColor;","void main(){","float isSelete = translate.w;","vec2 scale =vec2(size.x*width,size.y*maxHeight*ratioHeight);","#ifdef USE_TXUE","isSelete = 0.0;","float maxT = scale.y/(scale.x*perimeter);","vUv=vec2(uv.x+ fract( u_time * offset.x ), maxT*uv.y - fract( u_time * offset.y*maxT ) );","#endif","vSColor = isSelete==1.0?sHColor:vec4(sColor.rgb,sColor.a*opacity);","vEColor = isSelete==1.0?eHColor:vec4(eColor.rgb,eColor.a*opacity);","tPos = position;","vec3 mPosition = position*vec3(scale.x,scale.y,scale.x);","mPosition += translate.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( mPosition, 1.0 );","}"].join("\n"),CylidFShader:["#ifdef USE_TXUE","uniform sampler2D u_txue;","varying vec2 vUv;","#endif","varying vec3 tPos;","varying vec4 vSColor;","varying vec4 vEColor;","void main() { ","vec4 color = mix(vSColor,vEColor,vec4(tPos.y));","#ifdef USE_TXUE","vec2 uv = vec2(vUv.x>1.0?(vUv.x-1.0):vUv.x,vUv.y<0.0?(1.0+vUv.y):vUv.y);","color *= texture2D( u_txue, uv );","#endif","gl_FragColor = color;","}"].join("\n")};
var _Collects={obj:function(){return new THREE.Object3D()},color:function(c){return new THREE.Color(c)},clamp:function(v,mi,ma,df){return Math.min(ma,Math.max(mi,isNaN(v)?df:v))},limit:function(v,arr){return(arr.indexOf(v)!=-1)?v:arr[0]},checkStr:function(string1,string2,type){type=type||SVG_INIT.dataMatchType;if(type===1){return(string1===string2)}else{return(string1.indexOf(string2)===0||string2.indexOf(string1)===0)}},getStyle:function(cArr){return"rgba("+((cArr[0].r*255)|0)+","+((cArr[0].g*255)|0)+","+((cArr[0].b*255)|0)+","+cArr[1]+")"},getColorArr:function(str){if(isArray(str)){return str}var _arr=[];str=str+"";str=str.toLowerCase().replace(/\s/g,"");if(/^((?:rgba)?)\(\s*([^\)]*)/.test(str)){var arr=str.replace(/rgba\(|\)/gi,"").split(",");var hex=[pad2(Math.round(arr[0]*1||0).toString(16)),pad2(Math.round(arr[1]*1||0).toString(16)),pad2(Math.round(arr[2]*1||0).toString(16))];_arr[0]=_Collects.color("#"+hex.join(""));_arr[1]=Math.max(0,Math.min(1,(arr[3]*1||0)))}else{if("transparent"===str){_arr[0]=_Collects.color();_arr[1]=0}else{_arr[0]=_Collects.color(str);_arr[1]=1}}function pad2(c){return c.length==1?"0"+c:""+c}return _arr},handleColConfig:function(layerdata){layerdata.visible=layerdata.visible!=undefined?!!layerdata.visible:true;layerdata.name=layerdata.name+"";layerdata.xyRatio=layerdata.xyRatio!=undefined?layerdata.xyRatio:[1,1];layerdata.xyOffset=layerdata.xyOffset!=undefined?layerdata.xyOffset:[0,0];layerdata.sColors.forEach(function(value,i){layerdata.sColors[i]=_Collects.getColorArr(value)});layerdata.eColors.forEach(function(value,i){layerdata.eColors[i]=_Collects.getColorArr(value)});layerdata.tSColors.forEach(function(value,i){layerdata.tSColors[i]=_Collects.getColorArr(value)});layerdata.tEColors.forEach(function(value,i){layerdata.tEColors[i]=_Collects.getColorArr(value)});layerdata.txuepath=layerdata.txuepath;layerdata._txue&&layerdata._txue.dispose();layerdata._txue=_createImgTexture(layerdata.txuepath);layerdata.dynamic.duration=_Collects.clamp(layerdata.dynamic.duration-0,0,100,0.5);
layerdata.dynamic.type=parseInt(layerdata.dynamic.type)||1;layerdata.lightDynamic.offsetX=_Collects.clamp(layerdata.lightDynamic.offsetX-0,-1,1,0);layerdata.lightDynamic.offsetY=_Collects.clamp(layerdata.lightDynamic.offsetY-0,-1,1,0.5);layerdata.offset=new THREE.Vector2(layerdata.lightDynamic.offsetX,layerdata.lightDynamic.offsetY);layerdata.type=parseInt(layerdata.type)||1;layerdata.showPosType=parseInt(layerdata.showPosType)||1;layerdata.space=_Collects.clamp(layerdata.space-0,0,999,3);layerdata.width=_Collects.clamp(layerdata.width-0,0,999,20);layerdata.maxHeight=_Collects.clamp(layerdata.maxHeight-0,0,999,100);layerdata.highlightColor.forEach(function(value,i){layerdata.highlightColor[i]=_Collects.getColorArr(value)})},createTextTexture:function(text){var canvas=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");var context=canvas.getContext("2d");context.font='40px Times New Roman"';var maxLength=context.measureText(text).width;var leave=256||1;leave=(leave==3)?4:leave;var width=Math.min(256*leave,Math.max(64,THREE.Math.nextPowerOfTwo(maxLength+4)));canvas.width=canvas.height=width;context.shadowColor="black";context.shadowBlur=3;context.font="40px Times New Roman";context.textAlign="center";context.textBaseline="middle";context.fillStyle="white";context.fillText(text,width/2,width/2);var texture=new THREE.Texture(canvas);texture.needsUpdate=true;canvas=null;return texture}};var _Materials={basic:function(param){return new THREE.MeshBasicMaterial(param)},shader:function(param){return new THREE.ShaderMaterial(param)}};var _Geometries={geo:function(){return new THREE.Geometry()},buf:function(){return new THREE.BufferGeometry()},plane:function(w,h,ws,hs){return new THREE.PlaneGeometry(w,h,ws,hs)},insBuf:function(){return new THREE.InstancedBufferGeometry()}};function _setConfig(layerdata,opts){layerdata.visible=opts.visible!=undefined?opts.visible:layerdata.visible;layerdata.name=opts.name!=undefined?opts.name:layerdata.name;layerdata.sColors=isArray(opts.sColors)?opts.sColors:layerdata.sColors;
layerdata.eColors=isArray(opts.eColors)?opts.eColors:layerdata.eColors;layerdata.tSColors=isArray(opts.tSColors)?opts.tSColors:layerdata.tSColors;layerdata.tEColors=isArray(opts.tEColors)?opts.tEColors:layerdata.tEColors;layerdata.txuepath=opts.txuepath!=undefined?opts.txuepath:layerdata.txuepath;layerdata.xyRatio=opts.xyRatio!=undefined?[opts.xyRatio[0]-0||0,opts.xyRatio[1]-0||0]:layerdata.xyRatio;layerdata.xyOffset=opts.xyOffset!=undefined?[opts.xyOffset[0]-0||0,opts.xyOffset[1]-0||0]:layerdata.xyOffset;if(opts.dynamic){layerdata.dynamic.duration=opts.dynamic.duration!=undefined?opts.dynamic.duration:layerdata.dynamic.duration;layerdata.dynamic.type=opts.dynamic.type!=undefined?opts.dynamic.type:layerdata.dynamic.type}if(opts.lightDynamic){layerdata.lightDynamic.offsetX=opts.lightDynamic.offsetX!=undefined?opts.lightDynamic.offsetX:layerdata.lightDynamic.offsetX;layerdata.lightDynamic.offsetY=opts.lightDynamic.offsetY!=undefined?opts.lightDynamic.offsetY:layerdata.lightDynamic.offsetY}layerdata.type=opts.type!=undefined?opts.type:layerdata.type;layerdata.showPosType=opts.showPosType!=undefined?opts.showPosType:layerdata.showPosType;layerdata.space=opts.space!=undefined?opts.space:layerdata.space;layerdata.width=opts.width!=undefined?opts.width:layerdata.width;layerdata.maxHeight=opts.maxHeight!=undefined?opts.maxHeight:layerdata.maxHeight;(isArray(opts.highlightColor)&&opts.highlightColor.length<3)&&opts.highlightColor.forEach(function(value,i){layerdata.highlightColor[i]=value});layerdata.tags=opts.tags!=undefined?opts.tags:layerdata.tags}function _creatColMap(series,layerdata){for(var i=SVG_INIT.mEventArr.length-1;i>=0;i--){var child=SVG_INIT.mEventArr[i];if(child._isColumnar&&child.parent.LayerID==layerdata.layerid){SVG_INIT.mEventArr.splice(i,1)}}SVG_INIT.SVGMapLayers&&SVG_INIT.SVGMapLayers.children.forEach(function(layer){if(layer._isColMap&&layer.LayerID===layerdata.layerid){_disposeObj(layer);SVG_INIT.SVGMapLayers.remove(layer);layer=null}});_startTime=0;df_ItdMesh=null;
df_SltMesh=null;_getSegments(layerdata);layerdata.series=series;for(var i=0,len=series.length;i<len;i++){var _si=series[i]||{};if((_si.data||[]).length<=0){continue}if((_si.position||[]).length<=0){if(!_si.name){continue}for(var j=0,jl=SVG_INIT.shapesArr.length;j<jl;j++){var node=SVG_INIT.shapesArr[j];if(_Collects.checkStr(node._name,_si.name)){var offset=SVG_INIT.SVGMapObj[node._path_id].offset;var center=node._center;var x=(center.x-SVG_INIT.svgOffset.x)/SVG_INIT.WHRatio.x+offset[0];var y=(center.z-SVG_INIT.svgOffset.z)/SVG_INIT.WHRatio.z+offset[1];var _ratioX=SVG_INIT.svgOffset.x/SVG_INIT.WHRatio.x,_ratioZ=SVG_INIT.svgOffset.z/SVG_INIT.WHRatio.z,x=(x+_ratioX)*SVG_INIT.xyRatio[0]+SVG_INIT.xyOffset[0]-_ratioX;y=(y+_ratioZ)*SVG_INIT.xyRatio[1]+SVG_INIT.xyOffset[1]-_ratioZ;x=(x+_ratioX)*layerdata.xyRatio[0]+layerdata.xyOffset[0]-_ratioX;y=(y+_ratioZ)*layerdata.xyRatio[1]+layerdata.xyOffset[1]-_ratioZ;_si.vecs=[{vector:[x,y],value:""}];break}}}else{_si.vecs=[];_si.position.forEach(function(value){_si.vecs.push({vector:_transVec(value.vector||[],layerdata.xyRatio,layerdata.xyOffset),value:""})})}}var layerObject=_Collects.obj();var _obj=_cylMesh(layerObject,layerdata);if(!_obj){return}layerObject._isColMap=true;layerObject._perSpeed=layerdata.dynamic.duration===0?0:1/layerdata.dynamic.duration;layerObject.name=layerdata.name;layerObject.position.y=SVG_INIT._df_Tdata.py+0.1;layerObject.visible=layerObject._visible=layerdata.visible;layerObject._positionY=layerObject.position.y;layerObject.LayerID=layerdata.layerid;SVG_INIT.SVGMapLayers.add(layerObject);SVG_INIT.onRender(SVG_INIT.renderID.svg_columnarmap,_animation)}function _cylMesh(layerObject,layerdata){var _isTex=layerdata._txue!==null?true:false;var cylMat=_creatMaterial(layerdata),cyGeo=_creatCylGeo(layerdata._seg,_isTex);var _pGeo=_creatPGeo(),_pMat=_creatPMaterial();var object=new THREE.Mesh(cyGeo.geo,cylMat.mat);layerObject.add(object);var textObj=_Collects.obj();textObj._isText=true;layerObject.add(textObj);var series=layerdata.series,_i=0,_offset=0;
var translates=[],sizes=[],sColors=[],eColors=[];var tSColors=[],tEColors=[];for(var k=0,l=series.length;k<l;k++){var _si=series[k]||{};if((_si.data||[]).length<=0||((_si.position||[]).length<=0&&(_si.vecs||[]).length<=0)){continue}var _data=_si.data;for(var i=0,len=_data.length;i<len;i++){var infor=_data[i];var _weight=infor.weight,_sCl=layerdata.sColors[i]||layerdata.sColors[0],_eCl=layerdata.eColors[i]||layerdata.eColors[0],_sSCl=layerdata.tSColors[i]||layerdata.tSColors[0],_sECl=layerdata.tEColors[i]||layerdata.tEColors[0];if(infor.color){infor.color[0]&&(_sCl=_Collects.getColorArr(infor.color[0]));infor.color[1]&&(_eCl=_Collects.getColorArr(infor.color[1]))}for(var j=0,jl=_weight.length;j<jl;j++){var _w=_Collects.clamp(_weight[j]-0,0,1,1);sizes.push(1,_w);sColors.push(_sCl[0].r,_sCl[0].g,_sCl[0].b,_sCl[1]);eColors.push(_eCl[0].r,_eCl[0].g,_eCl[0].b,_eCl[1]);tSColors.push(_sSCl[0].r,_sSCl[0].g,_sSCl[0].b,_sSCl[1]);tEColors.push(_sECl[0].r,_sECl[0].g,_sECl[0].b,_sECl[1]);var _plane=new THREE.Mesh(_pGeo,_pMat);_plane.scale.set(layerdata.width,layerdata.maxHeight*_w,layerdata.width);_plane.LayerID=layerdata.layerid;_plane._index=_i++;_plane._style=i;_plane._vec=j;_plane._block=k;_plane._isColumnar=true;object.add(_plane);SVG_INIT.mEventArr.push(_plane);var _text=_textMesh(infor.value,layerdata.tags);_text.scale.set(layerdata.tags.size,layerdata.tags.size,1);textObj.add(_text)}}_offset=_getTranslates(object,translates,_offset,layerdata,_si)}var _translate=new THREE.InstancedBufferAttribute(new Float32Array(translates),4),_size=new THREE.InstancedBufferAttribute(new Float32Array(sizes),2),_sColor=new THREE.InstancedBufferAttribute(new Float32Array(sColors),4),_eColor=new THREE.InstancedBufferAttribute(new Float32Array(eColors),4),_tSColor=new THREE.InstancedBufferAttribute(new Float32Array(tSColors),4),_tEColor=new THREE.InstancedBufferAttribute(new Float32Array(tEColors),4);cyGeo.geo.addAttribute("translate",_translate);cyGeo.geo.addAttribute("size",_size);cyGeo.geo.addAttribute("sColor",_sColor);
cyGeo.geo.addAttribute("eColor",_eColor);if(_isTex){cyGeo.tGeo.addAttribute("translate",_translate);cyGeo.tGeo.addAttribute("size",_size);cyGeo.tGeo.addAttribute("sColor",_tSColor);cyGeo.tGeo.addAttribute("eColor",_tEColor);var _tObj=new THREE.Mesh(cyGeo.tGeo,cylMat.tMat);_tObj._isLightEff=true;_tObj.name=series.name+"_光效";_tObj.frustumCulled=false;object.add(_tObj)}object._ser=series;object.frustumCulled=false;return object}function _textMesh(text,config){var _txue=_Collects.createTextTexture(text);var _tag=new THREE.Sprite(new THREE.SpriteMaterial({map:_txue,color:config.color,depthWrite:false}));return _tag}function _getTranslates(obj,translates,offset,layerdata,series){var _data=series.data,pos=series.vecs,len=_data.length;var _tags=obj.parent.children[1];var vertexs=_setTranslates(layerdata,len);for(var i=0;i<len;i++){var _weight=_data[i].weight;for(var j=0,l=_weight.length;j<l;j++){var _vec=pos[j].vector;translates[offset*4]=_vec[0]+vertexs[i*2],translates[offset*4+1]=0,translates[offset*4+2]=_vec[1]+vertexs[i*2+1];translates[offset*4+3]=translates[offset*4+3]||0;obj.children[offset].position.set(translates[offset*4],translates[offset*4+1],translates[offset*4+2]);_tags.children[offset].position.set(translates[offset*4],translates[offset*4+1]+layerdata.maxHeight*_weight[j]+layerdata.tags.top,translates[offset*4+2]);offset++}}return offset}function _setTranslates(layerdata,len){var vertexs=[],_offsetX=0,_space=layerdata.space+layerdata.width,_width=layerdata.width;switch(layerdata.showPosType){case 1:_offsetX=-(len-1)*_space*0.5;for(var x=0;x<len;x++){vertexs.push(x*_space+_offsetX,0)}break;case 2:_offsetX=_width*0.5;for(var x=0;x<len;x++){vertexs.push(x*_space+_offsetX,0)}break;case 3:if(len>1){for(var x=0;x<len;x++){var u=x/len;var theta=u*6.283185307179586+0;var sinTheta=Math.sin(theta);var cosTheta=Math.cos(theta);vertexs.push(_space*sinTheta);vertexs.push(_space*cosTheta)}}else{vertexs.push(0,0)}break}return vertexs}function _creatCylGeo(_seg,open){var indices=[];
var vertices=[];var normals=[];var uvs=[];var radialSegments=Math.floor(_seg)||8;var heightSegments=1;var openEnded=!!open;var thetaStart=Math.PI/4;var thetaLength=Math.PI*2;var radiusTop=_tR;var radiusBottom=_tR;var height=1;var index=0;var indexArray=[];var x,y;var normal=new THREE.Vector3();var vertex=new THREE.Vector3();var slope=(radiusBottom-radiusTop)/height;for(y=0;y<=heightSegments;y++){var indexRow=[];var v=y/heightSegments;var radius=v*(radiusTop-radiusBottom)+radiusBottom;for(x=0;x<=radialSegments;x++){var u=x/radialSegments;var theta=u*thetaLength+thetaStart;var sinTheta=Math.sin(theta);var cosTheta=Math.cos(theta);vertex.x=radius*sinTheta;vertex.y=v*height;vertex.z=radius*cosTheta;vertices.push(vertex.x,vertex.y,vertex.z);normal.set(sinTheta,slope,cosTheta).normalize();normals.push(normal.x,normal.y,normal.z);uvs.push(u,v);indexRow.push(index++)}indexArray.push(indexRow)}for(x=0;x<radialSegments;x++){for(y=0;y<heightSegments;y++){var a=indexArray[y][x];var b=indexArray[y][x+1];var c=indexArray[y+1][x+1];var d=indexArray[y+1][x];indices.push(a,b,d);indices.push(b,c,d)}}var _geo=undefined,_tGeo=undefined;if(openEnded){_tGeo=_Geometries.insBuf();_tGeo.setIndex(indices.slice(0));_tGeo.addAttribute("position",new THREE.Float32BufferAttribute(vertices.slice(0),3));_tGeo.addAttribute("normal",new THREE.Float32BufferAttribute(normals.slice(0),3));_tGeo.addAttribute("uv",new THREE.Float32BufferAttribute(uvs.slice(0),2))}generateCap();_geo=_Geometries.insBuf();_geo.setIndex(indices);_geo.addAttribute("position",new THREE.Float32BufferAttribute(vertices,3));_geo.addAttribute("normal",new THREE.Float32BufferAttribute(normals,3));_geo.addAttribute("uv",new THREE.Float32BufferAttribute(uvs,2));function generateCap(){var x,centerIndexStart,centerIndexEnd;var vertex=new THREE.Vector3();var radius=radiusTop;var sign=1;centerIndexStart=index;vertices.push(0,height*sign,0);normals.push(0,sign,0);uvs.push(-1,0);index++;centerIndexEnd=index;for(x=0;x<=radialSegments;x++){var u=x/radialSegments;
var theta=u*thetaLength+thetaStart;var cosTheta=Math.cos(theta);var sinTheta=Math.sin(theta);vertex.x=radius*sinTheta;vertex.y=height*sign;vertex.z=radius*cosTheta;vertices.push(vertex.x,vertex.y,vertex.z);normals.push(0,sign,0);uvs.push(-1,0);index++}for(x=0;x<radialSegments;x++){var i=centerIndexEnd+x;indices.push(i,i+1,centerIndexStart)}}return{geo:_geo,tGeo:_tGeo}}function _creatPGeo(){if(df_pGeo){return df_pGeo}var pos=[-_tR,0,0,_tR,0,0,0,0,_tR,0,0,-_tR];var vertices=[],indices=[0,1,2,2,3,1,4,5,6,6,7,5];for(var i=0;i<4;i++){vertices.push(pos[i*3],pos[i*3+1],pos[i*3+2]);vertices.push(pos[i*3],pos[i*3+1]+1,pos[i*3+2])}df_pGeo=_Geometries.buf();df_pGeo.setIndex(indices);df_pGeo.addAttribute("position",new THREE.Float32BufferAttribute(vertices,3));df_pGeo.rotateY(Math.PI/4);return df_pGeo}function _creatMaterial(layerdata){var hColor=layerdata.highlightColor;var uniforms={sHColor:{value:new THREE.Vector4(hColor[0][0].r,hColor[0][0].g,hColor[0][0].b,hColor[0][1])},eHColor:{value:new THREE.Vector4(hColor[1][0].r,hColor[1][0].g,hColor[1][0].b,hColor[1][1])},maxHeight:{value:layerdata.maxHeight},width:{value:layerdata.width},perimeter:{value:layerdata._perimeter*0.5},ratioHeight:{value:layerdata.dynamic.type===1?0:1},opacity:{value:layerdata.dynamic.type===2?0:1}};Object.assign(uniforms,{u_time:{value:1},offset:{value:layerdata.offset},u_txue:{value:layerdata._txue}});var _shader={uniforms:uniforms,transparent:true,blending:THREE.NormalBlending};return{mat:_Materials.shader(Object.assign({vertexShader:_Shaders.CylidVShader,fragmentShader:_Shaders.CylidFShader},_shader)),tMat:_Materials.shader(Object.assign({vertexShader:"#define USE_TXUE\n"+_Shaders.CylidVShader,fragmentShader:"#define USE_TXUE\n"+_Shaders.CylidFShader},_shader))}}function _creatPMaterial(){if(df_pMat){return df_pMat}df_pMat=_Materials.basic({side:THREE.DoubleSide,visible:false});return df_pMat}function _getLayerInfor(layerId,opt,setCallback,callback){layerId=parseInt(layerId);if(isNaN(layerId)){return}var layerdata=SVG_INIT._getLayerData(layerId);
if(!layerdata.isColMap){return}setCallback&&setCallback(layerdata);layerdata[opt.name]=opt.value!==undefined?opt.value:layerdata[opt.name];var layer,children=SVG_INIT.SVGMapLayers.children;for(var i=0,len=children.length;i<len;i++){var child=children[i];if(child._isColMap&&child.LayerID===layerId){layer=child;break}}layer&&layer.children.forEach(function(child){child.material.uniforms[opt.name]&&(child.material.uniforms[opt.name].value=layerdata[opt.name]);callback&&callback(child,layerdata)})}function _getPolygonPerimeter(n,r){return 2*r*n*Math.sin(Math.PI/n)}function _getSegments(infor){switch(infor.type){case 1:infor._seg=4;break;case 2:infor._seg=5;break;case 3:infor._seg=6;break;case 4:infor._seg=8;break;case 5:infor._seg=30;break}infor._perimeter=_getPolygonPerimeter(infor._seg,_tR)}function _setSelectInfor(obj,value){var _translates=obj.parent.geometry.attributes["translate"];_translates.setW(obj._index,value);_translates.needsUpdate=true}function _getColumnarInfor(obj,event){return event?{type:true,layerId:obj.LayerID,series:obj.parent._ser[obj._block],index0:obj._style,index1:obj._vec,event:event}:{type:false,layerId:obj?obj.LayerID:null}}function _createImgTexture(value){if(typeof(value)=="undefined"||value==""){return null}return SVG_INIT._TxueLoader.load(value,function(tex){tex.minFilter=THREE.LinearFilter})}function _selfAnimation(obj,_elapsedTime,perSpeed){if(obj.value<1){obj.value=_elapsedTime*perSpeed;(perSpeed===0||obj.value>=1)&&(obj.value=1);return true}return false}function _animation(dt,clock){if(dt>0.1){return}!_startTime&&(_startTime=clock.elapsedTime);var _elapsedTime=clock.elapsedTime-_startTime;SVG_INIT.SVGMapLayers.children.forEach(function(layer){layer._isColMap&&layer.visible&&(layer.children.forEach(function(node){if(!node._isText){var uniforms=node.material.uniforms;if(!_selfAnimation(uniforms.ratioHeight,_elapsedTime,layer._perSpeed)&&!_selfAnimation(uniforms.opacity,_elapsedTime,layer._perSpeed)){uniforms.u_time&&(uniforms.u_time.value=_elapsedTime)
}}}))})}function _transVec(_vec,xyRatio,xyOffset){var vx=_Collects.clamp(_vec[0]*1,-Infinity,Infinity,0),vz=_Collects.clamp(_vec[1]*1,-Infinity,Infinity,0),_ratioX=SVG_INIT.svgOffset.x/SVG_INIT.WHRatio.x,_ratioZ=SVG_INIT.svgOffset.z/SVG_INIT.WHRatio.z,vector=SVG_INIT.CoordTrans.transCoord(vx,vz);vector[0]=(vector[0]+_ratioX)*SVG_INIT.xyRatio[0]+SVG_INIT.xyOffset[0]-_ratioX;vector[1]=(vector[1]+_ratioZ)*SVG_INIT.xyRatio[1]+SVG_INIT.xyOffset[1]-_ratioZ;return[(vector[0]+_ratioX)*xyRatio[0]+xyOffset[0]-_ratioX,(vector[1]+_ratioZ)*xyRatio[1]+xyOffset[1]-_ratioZ]}function _disposeObj(obj){if(obj instanceof THREE.Object3D){objectTraverse(obj,function(child){if(child.geometry){if(child.geometry._bufferGeometry){child.geometry._bufferGeometry.dispose()}child.geometry.dispose();child.geometry=null}if(child.material instanceof THREE.MultiMaterial){child.material.materials.forEach(function(mtl){disposeMaterial(mtl)})}else{if(child.material){disposeMaterial(child.material)}}if(child.parent){child.parent.remove(child)}child=null})}}function disposeMaterial(mtl){if(mtl.uniforms&&mtl.uniforms.u_txue&&mtl.uniforms.u_txue.value){if(mtl.__webglShader){mtl.__webglShader.uniforms.u_txue.value.dispose();mtl.__webglShader.uniforms.u_txue.value=null}else{mtl.uniforms.u_txue.value.dispose();mtl.uniforms.u_txue.value=null}}if(mtl.map){mtl.map.dispose();mtl.map=null;if(mtl.__webglShader){mtl.__webglShader.uniforms.map.value.dispose();mtl.__webglShader.uniforms.map.value=null}}mtl.dispose();mtl=null}function objectTraverse(obj,callback){if(!isFunction(callback)){return}var children=obj.children;for(var i=children.length-1;i>=0;i--){objectTraverse(children[i],callback)}callback(obj)}function isArray(o){return Object.prototype.toString.call(o)=="[object Array]"}function isFunction(a){return Object.prototype.toString.call(a)==="[object Function]"}function toFunction(a){var b=Object.prototype.toString.call(a)==="[object Function]";return b?a:function(o){}}};
